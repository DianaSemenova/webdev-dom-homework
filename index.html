<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments">
      <!-- Список рендерится из JS -->
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button">Написать</button>
        <button class="delete-form-button">Удалить последний комментарий</button>
      </div>

    </div>
  </div>
</body>

<script>
  "use strict";

  const inputNameElement = document.querySelector('.add-form-name');
  const inputTextElement = document.querySelector('.add-form-text');
  const buttonElement = document.querySelector('.add-form-button');
  const commentsElement = document.querySelector('.comments');
  const buttonElementDel = document.querySelector('.delete-form-button');

  const comments = [
    {
      name: 'Глеб Фокин',
      dateСreation: '12.02.22 12:18',
      textComment: 'Это будет первый комментарий на этой страницe',
      likeComment: false,
      likesNumber: 3,
      propertyColorLike: 'like-button -no-active-like',
    },
    {
      name: 'Варвара Н.',
      dateСreation: '13.02.22 19:22',
      textComment: 'Мне нравится как оформлена эта страница! ❤',
      likeComment: false,
      likesNumber: 75,
      propertyColorLike: 'like-button no-active-like',
    },
  ];



  //редактирование текста уже написанного комментария 
  function editorComment() {
    const editorButtonElements = document.querySelectorAll('.editor-button');
    const commentsBodyElements = document.querySelectorAll('.comment-body');//+
    const commentsTextElements = document.querySelectorAll('.comment-text');//+

    for (const editorButtonElement of editorButtonElements) {

      editorButtonElement.addEventListener("click", (event) => {
        event.stopPropagation();

        const editorButtonIndex = editorButtonElement.dataset.index;
        console.log(editorButtonIndex);

        if (editorButtonElement.textContent === 'Редактировать') {

          editorButtonElement.textContent = 'Сохранить';

          commentsBodyElements[editorButtonIndex].innerHTML = `<textarea class="comment-text">${comments[editorButtonIndex].textComment}</textarea>`;
          
        } else {

          comments[editorButtonIndex].textComment = editorButtonElement.closest('.comment').querySelector('textarea').value;
          comments[editorButtonIndex].dateСreation = `${currentDate} (изменено)`;
          renderComments();
        }
      }


      )
    }
  }


  editorComment();



  //первый вариант:комментарий и имя при клике на кнопку «Редактировать» подставляются  в уже существующую форму добавления комментария и имени
  // function editorComment() {
  // const editorButtonElements = document.querySelectorAll('.editor-button');

  // for (const editorButtonElement of editorButtonElements) {

  //   editorButtonElement.addEventListener("click", (event) => {
  //     event.stopPropagation();

  //     const editorButtonIndex = editorButtonElement.dataset.index;
  //     console.log(editorButtonIndex);


  //     if (editorButtonElement.textContent === 'Редактировать') {

  //       editorButtonElement.textContent = 'Сохранить';

  //       inputTextElement.value = `${comments[editorButtonIndex].textComment}`; 
  //       inputNameElement.value = `${comments[editorButtonIndex].name}`; 


  //     } else {
  //       comments[editorButtonIndex].textComment = inputTextElement.value;
  //       comments[editorButtonIndex].name = inputNameElement.value;
  //       comments[editorButtonIndex].dateСreation = `${currentDate} (изменено)`;
  //       renderComments();
  //       inputTextElement.value = '';
  //       inputNameElement.value = '';
  //     }

  //   }     
  //   )
  // }
  // };





  //счетчик лайков у каждого комментария
  function getLikeButton() {
    const likesButton = document.querySelectorAll('.like-button');
    for (const like of likesButton) {
      like.addEventListener("click", (event) => {

        event.stopPropagation();

        const likeIndex = like.dataset.index;
        const commentsElementLikeIndex = comments[likeIndex];

        if (commentsElementLikeIndex.likeComment) {
          commentsElementLikeIndex.likesNumber -= 1;
          commentsElementLikeIndex.likeComment = false;
          commentsElementLikeIndex.propertyColorLike = 'like-button -no-active-like';
        } else {
          commentsElementLikeIndex.likesNumber += 1;
          commentsElementLikeIndex.likeComment = true;
          commentsElementLikeIndex.propertyColorLike = 'like-button -active-like';
        }
        renderComments();

      })
    }
  };
  getLikeButton();


  let inputTextElementValue = '';

  //Ответы на комментарии
  function replyToComment() {

    let commentElements = document.querySelectorAll('.comment');

    for (const commentElement of commentElements) {
      commentElement.addEventListener("click", () => {

        const indexComment = commentElement.dataset.index;
        let QUOTE_BEGIN = 'QUOTE_BEGIN';
        // QUOTE_BEGIN.hidden = true;
        //QUOTE_BEGIN = QUOTE_BEGIN.hidden;

        let QUOTE_END = 'QUOTE_END';
        //QUOTE_END.hidden = true;
        // QUOTE_END = QUOTE_BEGIN.hidden;

        inputTextElement.value =
          `${QUOTE_BEGIN}${comments[indexComment].name}:\n${comments[indexComment].textComment}${QUOTE_END}\n\n`;

        // inputTextElement.value =
        // `QUOTE_BEGIN${comments[indexComment].name}:\n${comments[indexComment].textComment}QUOTE_END`;

        //inputTextElementValue =  `QUOTE_BEGIN${inputTextElement.value}QUOTE_END`;

        // inputNameElement = inputNameElement.replaceAll("QUOTE_BEGIN", "<div class='comment-quote'><b>")
        //   .replaceAll("QUOTE_END", "</b></div>")        

        //console.log(inputTextElementValue);
      }
      )
    }
  };

  replyToComment()

  const renderComments = () => {

    const commentsHtml = comments.map((comment, index) => {

      return `<li class="comment" data-index="${index}">
          <div class="comment-header" data-index="${index}">
            <div>${comment.name
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")}
            </div>
            <div>${comment.dateСreation}</div>
          </div>
          <div class="comment-body">
            <div data-index="${index}" class="comment-text" >
              ${comment.textComment
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll('QUOTE_BEGIN', "<div class='comment-quote'><b>")
          .replaceAll('QUOTE_END', "</b></div>")
        }
            </div>
          </div>
          <div class="comment-footer">
            <div class="editor">
            <button data-index="${index}" class='editor-button'>Редактировать</button>
            </div>
            <div class="likes">
              <span class="likes-counter"> ${comment.likesNumber}</span>
              <button data-index="${index}" class='${comment.propertyColorLike}'></button>
            </div>
          </div>
        </li>`;
    }).join("");


    commentsElement.innerHTML = commentsHtml;
    getLikeButton();
    replyToComment();
    editorComment();
  };

  renderComments();




  //доп.задание1  кнопка «Написать» не кликабельна, если имя или текст в форме незаполненные.
  buttonElement.setAttribute('disabled', true);

  inputNameElement.addEventListener("input", () => {

    buttonElement.setAttribute('disabled', true);

    if ((inputNameElement.value.length > 0) && (inputTextElement.value.length > 0)) {

      buttonElement.removeAttribute('disabled');
    }
  });

  inputTextElement.addEventListener("input", () => {

    buttonElement.setAttribute('disabled', true);

    if ((inputNameElement.value.length > 0) && (inputTextElement.value.length > 0)) {

      buttonElement.removeAttribute('disabled');
    }
  });


  const currentDate = new Date().getDate().toString().padStart(2, '0') + '.' +
    (new Date().getMonth() + 1).toString().padStart(2, '0') + '.' +
    new Date().getFullYear().toString().slice(-2) + " " +
    new Date().toLocaleTimeString().slice(0, -3);

  // const currentDate = new Date().toLocaleDateString('default', {day: '2-digit', month: '2-digit', year: '2-digit'}) +
  // " "+ new Date().toLocaleTimeString().slice(0,-3);


  buttonElement.addEventListener("click", () => {

    buttonElement.setAttribute('disabled', true);


    comments.push({
      name: inputNameElement.value,
      dateСreation: currentDate,
      textComment: inputTextElement.value,
      likeComment: false,
      likesNumber: 0,
      propertyColorLike: 'like-button -no-active-like',
    });
    renderComments();



    inputNameElement.value = "";
    inputTextElement.value = "";


  });


  ///Доп.задание2 нажатие клавиши Enter должно вызывать ту же логику, которая срабатывает при клике на кнопку «Добавить».
  document.addEventListener("keyup", function (event) {
    if (event.shiftKey && (event.keyCode === 13)) {
      //переносит на другую строку
    } else if (event.keyCode === 13) {
      buttonElement.click();
    }
  });

  //удаление последнего комментари
  buttonElementDel.addEventListener("click", () => {

    comments.pop();
    renderComments();

    // const lastElement = commentsElement.lastElementChild;
    // lastElement.remove();
  });
</script>

</html>